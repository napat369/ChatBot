# 深思智聊平台 - 部署操作指南

## 🚀 部署方式选择

### 方式一：自动化部署（推荐）
使用自动化脚本一键部署到Linux服务器

### 方式二：手动部署
手动上传文件并配置服务器

---

## 📦 方式一：自动化部署

### 1. 准备工作

在Windows本地确保已安装：
- Git Bash 或 WSL
- SSH客户端

### 2. 执行自动化部署

```bash
# 在项目根目录执行
chmod +x deploy-to-server.sh

# 部署到服务器
./deploy-to-server.sh 服务器IP 用户名 [可选:远程路径]

# 示例
./deploy-to-server.sh 192.168.1.100 ubuntu
./deploy-to-server.sh 123.456.789.10 root /opt/chatbot
```

### 3. 配置环境变量

部署完成后，SSH连接到服务器：

```bash
ssh ubuntu@192.168.1.100
cd /home/ubuntu/chatbot-system

# 编辑环境变量
nano .env.production.local
```

配置以下关键参数：
```bash
DEEPSEEK_API_KEY=sk-your-api-key-here
MYSQL_ROOT_PASSWORD=your_secure_password
MYSQL_PASSWORD=another_secure_password
DOMAIN_NAME=your-domain.com  # 如果有域名
```

### 4. 启动服务

```bash
./deploy.sh start
```

---

## 🔧 方式二：手动部署

### 1. 准备服务器文件

#### 方法A：使用SCP上传
```bash
# 压缩项目文件
tar --exclude='node_modules' --exclude='.git' --exclude='*.log' -czf chatbot.tar.gz .

# 上传到服务器
scp chatbot.tar.gz ubuntu@192.168.1.100:/home/ubuntu/

# SSH连接服务器
ssh ubuntu@192.168.1.100

# 解压文件
cd /home/ubuntu
tar -xzf chatbot.tar.gz
mv chatbot-system /home/ubuntu/chatbot-system
cd chatbot-system
```

#### 方法B：使用Git克隆
```bash
# 在服务器上执行
git clone https://github.com/your-username/chatbot-system.git
cd chatbot-system
```

#### 方法C：使用FTP工具
使用FileZilla、WinSCP等工具上传以下文件：
- `docker-compose.yml`
- `deploy.sh`
- `.env.production`
- `backend/` 目录
- `frontend/` 目录
- `deploy/` 目录

### 2. 安装Docker环境

```bash
# 更新系统
sudo apt update

# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 重新登录以应用用户组变更
exit
# 重新SSH连接
```

### 3. 配置环境变量

```bash
cd /path/to/chatbot-system
cp .env.production .env.production.local
nano .env.production.local
```

### 4. 启动服务

```bash
chmod +x deploy.sh
./deploy.sh start
```

---

## 🌐 域名绑定配置

### 1. DNS配置

在域名服务商控制台添加A记录：
```
类型: A
主机记录: @ 或 www
记录值: 你的服务器IP
TTL: 600
```

### 2. 配置SSL证书

```bash
# 编辑环境变量
nano .env.production.local

# 添加域名配置
DOMAIN_NAME=your-domain.com
SSL_EMAIL=your-email@example.com

# 申请SSL证书
./deploy.sh ssl
```

### 3. 更新Nginx配置

SSL证书申请成功后，重启服务：
```bash
./deploy.sh restart
```

---

## 📋 常用管理命令

### 服务管理
```bash
./deploy.sh start     # 启动服务
./deploy.sh stop      # 停止服务
./deploy.sh restart   # 重启服务
./deploy.sh status    # 查看状态
```

### 日志查看
```bash
./deploy.sh logs              # 查看所有日志
./deploy.sh logs backend      # 查看后端日志
./deploy.sh logs frontend     # 查看前端日志
./deploy.sh logs mysql        # 查看数据库日志
```

### 维护操作
```bash
./deploy.sh update    # 更新服务
./deploy.sh backup    # 备份数据
```

---

## 🔍 故障排除

### 1. 端口检查
```bash
# 检查端口占用
sudo netstat -tlnp | grep :80
sudo netstat -tlnp | grep :443

# 开放防火墙端口
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable
```

### 2. Docker问题
```bash
# 检查Docker状态
sudo systemctl status docker

# 重启Docker
sudo systemctl restart docker

# 查看容器状态
docker ps -a
```

### 3. 权限问题
```bash
# 确保用户在docker组中
sudo usermod -aG docker $USER

# 设置文件权限
chmod +x deploy.sh
sudo chown -R $USER:$USER /path/to/chatbot-system
```

### 4. 内存不足
```bash
# 检查系统资源
free -h
df -h

# 清理Docker资源
docker system prune -f
```

---

## 📊 性能优化建议

### 1. 服务器配置
- **最低配置**：2核CPU，4GB内存，20GB存储
- **推荐配置**：4核CPU，8GB内存，50GB存储

### 2. 数据库优化
```bash
# 编辑MySQL配置
nano deploy/mysql/my.cnf

# 添加优化参数
[mysqld]
innodb_buffer_pool_size = 1G
max_connections = 200
```

### 3. 缓存配置
```bash
# Redis内存限制
# 在docker-compose.yml中添加
command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
```

---

## 🔐 安全建议

### 1. 修改默认密码
```bash
# 生成强密码
openssl rand -base64 32

# 更新环境变量中的密码
nano .env.production.local
```

### 2. 配置防火墙
```bash
# 只开放必要端口
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable
```

### 3. 定期备份
```bash
# 设置定时备份
crontab -e

# 添加定时任务（每天凌晨2点备份）
0 2 * * * /path/to/chatbot-system/deploy.sh backup
```

---

## 📞 技术支持

如遇到问题，请按以下步骤排查：

1. 检查服务状态：`./deploy.sh status`
2. 查看错误日志：`./deploy.sh logs`
3. 检查系统资源：`free -h && df -h`
4. 验证网络连接：`curl -I http://localhost`

更多帮助：`./deploy.sh help`